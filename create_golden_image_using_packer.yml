---
- hosts: all
  name: Create a golden image using Packer

  vars:
    out_dir: "/opt/packer/templates"
    images:
      - packer_target: "gcp"
        gcp:
          project_id: my-project
          zone: us-central1-a
          image_name: my-image
          machine_type: e2-medium
          source_image_family: ubuntu-2004-lts
          disk_size_gb: 20
      - packer_target: "ahv"
        ahv:
          prism_endpoint: https://prism.example.com
          username: admin
          password: secret
          cluster: my-cluster
          image_name: my-ahv-image
          vm_cpus: 2
          vm_memory_mb: 4096

  tasks: 
    - name: Ensure generated output directory exists
      ansible.builtin.file:
        path: "{{ out_dir }}"
        state: directory
        mode: '0755'

    - name: Create HCL template using the provided variables
      ansible.builtin.template:
        src: "templates/packer-hcl.j2"
        dest: "{{ out_dir }}/packer-{{ item.packer_target }}.pkr.hcl"
      vars:
        packer_target: "{{ item.packer_target }}"
        gcp: "{{ item.gcp | default({}) }}"
        ahv: "{{ item.ahv | default({}) }}"
      loop: "{{ images }}"

    - name: Init / fmt / validate Packer templates (with rescue on error)
      block:
        - name: Initialize Packer
          ansible.builtin.command:
            cmd: packer init .
            chdir: "{{ out_dir }}"
          register: packer_init

        - name: Format Packer templates
          ansible.builtin.command:
            cmd: packer fmt .
            chdir: "{{ out_dir }}"
          register: packer_fmt

        - name: Validate Packer templates
          ansible.builtin.command:
            cmd: packer validate .
            chdir: "{{ out_dir }}"
          register: packer_validate

      rescue:
        - name: packer init output
          ansible.builtin.debug:
            msg: |
              packer init rc={{ packer_init.rc | default('n/a') }}
              stdout: {{ packer_init.stdout | default('') }}
              stderr: {{ packer_init.stderr | default('') }}

        - name: packer fmt output
          ansible.builtin.debug:
            msg: |
              packer fmt rc={{ packer_fmt.rc | default('n/a') }}
              stdout: {{ packer_fmt.stdout | default('') }}
              stderr: {{ packer_fmt.stderr | default('') }}

        - name: packer validate output
          ansible.builtin.debug:
            msg: |
              packer validate rc={{ packer_validate.rc | default('n/a') }}
              stdout: {{ packer_validate.stdout | default('') }}
              stderr: {{ packer_validate.stderr | default('') }}

        - name: Fail with summary
          ansible.builtin.fail:
            msg: "Packer init/fmt/validate failed. See previous debug messages for details."
      
    - name: Build Golden Images based on HCL templates
      ansible.builtin.command: packer build {{ out_dir }}/packer-{{ item.packer_target }}.pkr.hcl
      loop: "{{ images }}"